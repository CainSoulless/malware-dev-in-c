/* This program only can run on Linux.
 * 
 */
#include <stdio.h>
#include <sys/utsname.h>
#include <sys/statvfs.h>
#include <unistd.h>
#include <stdlib.h>
#include <stdint.h>
#include <pwd.h>

#include "username.c"
#include "vm_detection.c"
#include "utils.c"
#define GB 1000000000

struct Hdd {
    uint64_t totalSpace;
    uint64_t freeSpace;
    uint64_t totalSpaceInGb;
    uint64_t freeSpaceInGb;
    char cwd[1024];
};

struct Hdd hdd_information()
{
    struct Hdd info = {0, 0, 0, 0, NULL};
    struct statvfs buf;

    if (getcwd(info.cwd, sizeof(info.cwd)) == NULL)
    {
        error_print();
    }

    if (statvfs("/", &buf) != 0)
    {
        error_print();
        return (struct Hdd){0, 0, 0, 0};
    }

    info.totalSpace = buf.f_frsize * buf.f_blocks;
    info.freeSpace = buf.f_frsize * buf.f_bfree;
    info.totalSpaceInGb = info.totalSpace / GB;
    info.freeSpaceInGb = info.freeSpace / GB;

    puts("\n\tHDD info:");
    printf("Total: \t\t%ld (%ld Gb aprox.)\n", info.totalSpace, info.totalSpaceInGb);
    printf("Free: \t\t%ld (%ld Gb aprox.)\n", info.freeSpace, info.freeSpaceInGb);
    printf("Name: \t\t%s\n", info.cwd);
    return info;
}

int64_t ram_information()
{
    long pageSize = sysconf(_SC_PAGE_SIZE);
    long numPages = sysconf(_SC_PHYS_PAGES);
    long totalMemoryInBits = pageSize * numPages;
    long totalMemoryInGb = totalMemoryInBits / GB;

    puts("\n\tRAM info:");
    printf("Total RAM:\t%ld (%ld Gb aprox.)\n", totalMemoryInBits, totalMemoryInGb);
    return totalMemoryInGb;
}

int processor_information() 
{
    long nProcs = sysconf(_SC_NPROCESSORS_ONLN);
    long hzProcs= sysconf(_SC_CLK_TCK);

    if (nProcs == -1 && hzProcs == -1)
    {
        error_print();
        return -1;
    }

    puts("\n\tProcessor info:");
    printf("Num procs:\t%ld\n", nProcs);
    printf("Hz procs:\t%ld\n", hzProcs);
    return nProcs;
}

void main_information()
{
    struct utsname buf;

    if (uname(&buf) != 0)
    {
        error_print();
    }

    printf("OS:\t\t%s\n", buf.sysname);
    printf("Ver:\t\t%s\n", buf.release);
    printf("Node name:\t%s\n", buf.nodename);
    printf("Arch:\t\t%s\n", buf.machine);

}

int main(void)
{
    int64_t ram = ram_information();
    int64_t procs = processor_information();
    struct Hdd info = hdd_information();

    if (isVM(ram, procs, info.totalSpaceInGb ))
    {
        exit(1);
    }

    main_information();
}