/* This program only can run on Linux.
 * 
 */
#include <stdio.h>
#include <stdbool.h>
#include <sys/utsname.h>
#include <sys/statvfs.h>
#include <unistd.h>
#include <stdlib.h>
#include <stdint.h>
#include <pwd.h>

#include "username.c"
#include "vm_detection.c"
#include "utils.c"
#include "structures.h"
#define GB 1000000000


struct Hdd hdd_information()
{
    struct Hdd info = {0, 0, 0, 0, 0};
    struct statvfs buf;

    if (getcwd(info.cwd, sizeof(info.cwd)) == NULL)
    {
        error_print();
    }

    if (statvfs("/", &buf) != 0)
    {
        error_print();
        return (struct Hdd){0, 0, 0, 0};
    }

    info.totalSpace = buf.f_frsize * buf.f_blocks;
    info.freeSpace = buf.f_frsize * buf.f_bfree;
    info.totalSpaceInGb = info.totalSpace / GB;
    info.freeSpaceInGb = info.freeSpace / GB;

    puts("\n\tHDD info:");
    printf("Total: \t\t%ld (%ld Gb aprox.)\n", info.totalSpace, info.totalSpaceInGb);
    printf("Free: \t\t%ld (%ld Gb aprox.)\n", info.freeSpace, info.freeSpaceInGb);
    printf("Name: \t\t%s\n", info.cwd);
    return info;
}

struct Ram ram_information()
{
    struct Ram ram = {0, 0};

    long pageSize = sysconf(_SC_PAGE_SIZE);
    long numPages = sysconf(_SC_PHYS_PAGES);
    ram.totalMemoryInBits = pageSize * numPages;
    ram.totalMemoryInGb = ram.totalMemoryInBits / GB;

    printf("---------------------------%ld\n", ram.totalMemoryInGb);

    // return ram.totalMemoryInGb;
    return ram;
}

struct Processor processor_information() 
{
    struct Processor proc = {0, 0};
    proc.coresProc = sysconf(_SC_NPROCESSORS_ONLN);
    proc.hzProc = sysconf(_SC_CLK_TCK);

    if (proc.coresProc == -1 && proc.hzProc == -1)
    {
        error_print();
    }

    puts("\n\tProcessor info:");
    printf("Num procs:\t%ld\n", proc.coresProc);
    printf("Hz procs:\t%ld\n", proc.hzProc);
    return proc;
}

struct utsname os_information()
{
    struct utsname buf;

    if (uname(&buf) != 0)
    {
        error_print();
    }

    printf("OS:\t\t%s\n", buf.sysname);
    printf("Ver:\t\t%s\n", buf.release);
    printf("Node name:\t%s\n", buf.nodename);
    printf("Arch:\t\t%s\n", buf.machine);
    return buf;
}

int main(void)
{
    struct Ram ram = ram_information();
    struct Processor procs = processor_information();
    struct Hdd hdd = hdd_information();

    // if (isVM(ram_information(), processor_information(), hdd_information()))
    if (isVM(ram, procs, hdd))
    {
        exit(1);
    }

    os_information();
}