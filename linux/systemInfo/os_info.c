/* This program only can run on Linux.
 * 
 */
#include <stdio.h>
#include <stdbool.h>
#include <sys/utsname.h>
#include <sys/statvfs.h>
#include <unistd.h>
#include <stdlib.h>
#include <stdint.h>
#include <pwd.h>
#include <X11/Xlib.h>
#include <X11/Xatom.h>

#include "username.c"
#include "vm_detection.c"
#include "utils.c"
#include "structures.h"
// #include "wallpaper_changer.c"

struct Hdd hdd_information()
{
    struct Hdd hdd_info = {0, 0, 0, 0, 0};
    struct statvfs buf;

    if (getcwd(hdd_info.cwd, sizeof(hdd_info.cwd)) == NULL)
    {
        error_print();
    }

    if (statvfs("/", &buf) != 0)
    {
        error_print();
        return (struct Hdd){0, 0, 0, 0};
    }

    hdd_info.totalSpace = buf.f_frsize * buf.f_blocks;
    hdd_info.freeSpace = buf.f_frsize * buf.f_bfree;
    hdd_info.totalSpaceInGb = hdd_info.totalSpace / GB;
    hdd_info.freeSpaceInGb = hdd_info.freeSpace / GB;

    return hdd_info;
}

struct Ram ram_information()
{
    struct Ram ram = {0, 0};

    long pageSize = sysconf(_SC_PAGE_SIZE);
    long numPages = sysconf(_SC_PHYS_PAGES);
    ram.totalMemoryInBits = pageSize * numPages;
    ram.totalMemoryInGb = ram.totalMemoryInBits / GB;

    return ram;
}

struct Processor processor_information() 
{
    struct Processor proc = {0, 0};
    proc.coresProc = sysconf(_SC_NPROCESSORS_ONLN);
    proc.hzProc = sysconf(_SC_CLK_TCK);

    if (proc.coresProc == -1 && proc.hzProc == -1)
    {
        error_print();
    }

    return proc;
}

struct utsname os_information()
{
    struct utsname buf;

    if (uname(&buf) != 0)
    {
        error_print();
    }

    return buf;
}

int main(void)
{
    struct Ram ram = ram_information();
    struct Processor proc = processor_information();
    struct Hdd hdd = hdd_information();
    struct utsname os = os_information();

    if (isVM(ram, proc, hdd))
    {
        return 1;
    }

    print_all_information(ram, proc, hdd, os);
    // wallpaper_change();
}